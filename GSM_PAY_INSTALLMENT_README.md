# راهنمای راه‌اندازی درگاه پرداخت اعتباری GSM Pay

## مقدمه
این راهنما نحوه راه‌اندازی درگاه پرداخت اعتباری GSM Pay را در پروژه Laravel شما توضیح می‌دهد. این پیاده‌سازی دقیقاً مطابق با [مستندات رسمی GSM Pay API](https://api.gsmpay.ir/cpg/json/docs?cpg-api.json) انجام شده است.

## پیش‌نیازها
- Laravel 8.x یا بالاتر
- پکیج `shetabit/multipay` نصب شده
- دسترسی به API درگاه پرداخت GSM Pay

## مراحل راه‌اندازی

### 1. نصب و پیکربندی
پس از اعمال تغییرات کد، مراحل زیر را انجام دهید:

#### الف) اجرای Migration
```bash
php artisan migrate
```

#### ب) پیکربندی درگاه در پنل مدیریت
1. به بخش تنظیمات > درگاه‌های پرداخت بروید
2. درگاه `GSM Pay اقساطی` را فعال کنید
3. اطلاعات زیر را وارد کنید:
   - `merchant_code`: کد پذیرنده دریافتی از GSM Pay

### 2. استفاده از API

#### ایجاد درخواست پرداخت اقساطی
```http
POST /api/v1/installment/create
Authorization: Bearer {token}
Content-Type: application/json

{
    "order_id": 123,
    "national_code": "1234567890",
    "first_name": "نام",
    "last_name": "نام خانوادگی"
}
```

#### پاسخ موفق
```json
{
    "status": "success",
    "message": "درخواست پرداخت اقساطی ایجاد شد",
    "data": {
        "payment_form": "<form>...</form>",
        "transaction_id": "abc123",
        "redirect_url": "https://api.gsmpay.ir/v1/cpg/payment/abc123"
    }
}
```

#### دریافت اطلاعات اقساط
```http
GET /api/v1/installment/info?order_id=123
Authorization: Bearer {token}
```

#### پاسخ موفق
```json
{
    "status": "success",
    "data": {
        "order_id": 123,
        "total_amount": 1000000,
        "installment_count": 3,
        "installment_amount": 333334,
        "installments": [
            {
                "number": 1,
                "amount": 166667,
                "due_date": "2024-02-01",
                "status": "pending"
            }
        ]
    }
}
```

### 3. فرآیند پرداخت

#### مرحله 1: ایجاد درخواست
- کاربر درخواست پرداخت اعتباری را ارسال می‌کند
- سیستم تراکنش را ثبت می‌کند
- فرم پرداخت به کاربر نمایش داده می‌شود

#### مرحله 2: پرداخت
- کاربر به درگاه پرداخت GSM Pay هدایت می‌شود
- اطلاعات کارت و شرایط اعتباری را وارد می‌کند
- پس از تایید، به callback URL بازگردانده می‌شود

#### مرحله 3: تایید
- سیستم پرداخت را تایید می‌کند
- سفارش به وضعیت "پرداخت شده" تغییر می‌کند
- اطلاعات اعتباری ثبت می‌شود

### 4. مدیریت خطاها

#### خطاهای رایج
- `خطا در احراز هویت`: بررسی username و password
- `خطا در ایجاد درخواست پرداخت`: بررسی تنظیمات درگاه
- `خطا در تایید پرداخت`: بررسی callback URL و تنظیمات

#### راه‌حل‌ها
1. تنظیمات درگاه را بررسی کنید
2. callback URL را درست تنظیم کنید
3. لاگ‌های سیستم را بررسی کنید

### 5. تست

#### محیط تست
- از تنظیمات sandbox استفاده کنید
- مبالغ کم برای تست انتخاب کنید
- تمام سناریوهای خطا را تست کنید

#### تست‌های ضروری
- [ ] ایجاد درخواست پرداخت
- [ ] هدایت به درگاه
- [ ] بازگشت موفق
- [ ] تایید پرداخت
- [ ] مدیریت خطاها

## نکات مهم

### امنیت
- از HTTPS استفاده کنید
- callback URL را محدود کنید
- اطلاعات حساس را لاگ نکنید

### عملکرد
- از queue برای عملیات سنگین استفاده کنید
- تراکنش‌ها را در دیتابیس ذخیره کنید
- خطاها را مدیریت کنید

### پشتیبانی
- مستندات API GSM Pay را مطالعه کنید
- با تیم پشتیبانی GSM Pay در ارتباط باشید
- تغییرات API را پیگیری کنید

## عیب‌یابی

### مشکل: درگاه فعال نمی‌شود
**راه‌حل**: بررسی کنید که کلاس Driver درست ایجاد شده باشد

### مشکل: خطای احراز هویت
**راه‌حل**: merchant_code را بررسی کنید

### مشکل: callback کار نمی‌کند
**راه‌حل**: URL callback را در تنظیمات درگاه بررسی کنید

## پشتیبانی
برای دریافت کمک بیشتر:
- مستندات Laravel
- مستندات پکیج multipay
- مستندات API GSM Pay
- تیم پشتیبانی پروژه

## تغییرات آینده
- پشتیبانی از اقساط متغیر
- مدیریت خودکار اقساط
- گزارش‌گیری پیشرفته
- پنل مدیریت اقساط 